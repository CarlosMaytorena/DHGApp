
<div class="text-center">

    <!-- Header -->
    <div class="row top-row-spacer">
        <div class="col-md-8">
            <h4 class="page-title">Reimpresión de Etiquetas</h4>
        </div>

        <div class="col-md-4 text-md-right text-sm-left">
            <button id="btnReimprimirSeleccion" class="btn btn-block secondary-background-color" style="color:white" disabled>
                <i class="fas fa-print"></i>
                Reimprimir seleccionados
            </button>
        </div>
    </div>

    <!-- Búsqueda -->
    <div class="card card-margin">
        <div class="row card-row-spacer align-items-end">
            <div class="col-md-6 mb-3">
                <label style="font-weight: normal; float: left">Orden de compra</label>
                <input id="ordenDeCompraInput" class="form-control" placeholder="Ingresa el número de orden" />
            </div>

            <div class="col-md-3 mb-3">
                <button id="btnBuscarOrden" class="btn btn-block btn-primary">
                    <i class="fas fa-search"></i>
                    Buscar
                </button>
            </div>
        </div>
    </div>

    <!-- Resultados -->
    <div class="card card-margin" id="resultadosCard" style="display:none;">
        <div class="row card-row-spacer">
            <div class="col-md-12">
                <h5 class="text-left">Seriales encontrados</h5>

                <div class="table-responsive">
                    <table class="table table-sm table-bordered table-hover" id="tablaSeriales">
                        <thead class="thead-light">
                            <tr>
                                <th style="width:40px;">
                                    <input type="checkbox" id="chkAll" />
                                </th>
                                <th>Serial</th>
                                <th>Producto</th>
                                <th>Fecha ingreso</th>
                                <th style="width:80px;">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Filas dinámicas -->
                        </tbody>
                    </table>
                </div>

                <div id="noResultadosMsg" class="alert alert-warning" style="display:none; text-align:left;">
                    No se encontraron seriales para esa orden.
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { openPrintWindow } from "/js/labelPrinter.js";

    function showWarning(msg) {
        $("#modal-warning-msg").text(msg || "");
        $("#modal-warning").modal("show");
    }

    function showSuccess(msg) {
        $("#modal-success-msg").text(msg || "");
        $("#modal-success").modal("show");
    }

    const esc = (s) => String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");

    let ultimosResultados = [];

    function scrambleSerial(serial) {
        serial = String(serial || "");
        if (serial.length !== 12) return serial;
        return serial.substring(6) + serial.substring(0, 6);
    }

    function syncReimprimirSeleccionButton() {
        const algunoMarcado = $(".chkFila:checked").length > 0;
        $("#btnReimprimirSeleccion").prop("disabled", !algunoMarcado);
    }

    function renderTabla(resultados, orden) {
        const $tbody = $("#tablaSeriales tbody");
        $tbody.empty();

        if (!resultados || resultados.length === 0) {
            $("#noResultadosMsg").show();
            $("#tablaSeriales").hide();
            $("#btnReimprimirSeleccion").prop("disabled", true);
            return;
        }

        $("#noResultadosMsg").hide();
        $("#tablaSeriales").show();

        resultados.forEach((row, idx) => {
            const originalSerial = row.serial;
            const scrambled = scrambleSerial(originalSerial);

            const safeSerialOriginal = esc(originalSerial);
            const safeScrambled = esc(scrambled);
            const safeProd = esc(row.producto || "");
            const safeFecha = esc(row.fecha || "");

            const tr = `
            <tr data-index="${idx}">
                <td class="text-center">
                    <input type="checkbox" class="chkFila" data-serial="${safeSerialOriginal}" />
                </td>
                <td>${safeScrambled}</td>
                <td>${safeProd}</td>
                <td>${safeFecha}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-secondary btn-imprimir-uno" data-serial="${safeSerialOriginal}">
                        <i class="fas fa-print"></i>
                    </button>
                </td>
            </tr>
        `;
            $tbody.append(tr);
        });


        // Eventos dinámicos
        $(".chkFila").on("change", syncReimprimirSeleccionButton);

        $("#chkAll").off("change").on("change", function () {
            const marcado = $(this).is(":checked");
            $(".chkFila").prop("checked", marcado);
            syncReimprimirSeleccionButton();
        });

        $(".btn-imprimir-uno").on("click", function () {
            const serial = $(this).data("serial");
            imprimirSeriales([serial], orden);
        });
    }

    function imprimirSeriales(listaSeriales, orden) {
        const labels = listaSeriales.map(serial => {
            const info = ultimosResultados.find(x => x.serial === serial) || {};
            const producto = info.producto || "";

            const scrambled = scrambleSerial(serial);

            return `
                <div class="label">
                    <h4>Orden: ${esc(orden)}</h4>
                    ${producto ? `<h4>Producto: ${esc(producto)}</h4>` : ""}
                    <h4 class="serial-header">Serial: ${esc(scrambled)}</h4>

                    <svg class="barcode"
                         data-barcode-value="${esc(serial)}"          <!-- ORIGINAL -->
                         data-scrambled="${esc(scrambled)}"></svg>    <!-- SCRAMBLED -->

                    <div class="serial-below">${esc(scrambled)}</div>
                </div>
            `;
        });
        openPrintWindow(labels.join(""), orden);
    }

    $("#btnReimprimirSeleccion").on("click", function () {
        const orden = ($("#ordenDeCompraInput").val() || "").trim();
        if (!orden) {
            showWarning("Falta la orden.");
            return;
        }

        const seleccionados = $(".chkFila:checked")
            .map(function () { return $(this).data("serial"); })
            .get();

        if (seleccionados.length === 0) {
            showWarning("Selecciona al menos un serial.");
            return;
        }

        imprimirSeriales(seleccionados, orden);
    });

    $("#btnBuscarOrden").on("click", function () {
        const orden = ($("#ordenDeCompraInput").val() || "").trim();
        if (!orden) {
            showWarning("Por favor ingresa la orden.");
            return;
        }

        $.ajax({
            url: "/Reimpresion/ObtenerSerialesPorOrden",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ orden }),
            success: function (response) {
                if (!response || !response.success) {
                    showWarning(response && response.error
                        ? response.error
                        : "No se pudo obtener la información de la orden.");
                    return;
                }

                ultimosResultados = response.data || [];

                $("#resultadosCard").show();

                $("#chkAll").prop("checked", false);
                $("#btnReimprimirSeleccion").prop("disabled", true);

                renderTabla(ultimosResultados, response.orden || orden);
            },
            error: function () {
                showWarning("Error al buscar la orden.");
            }
        });
    });
</script>

<div class="modal fade" id="modal-warning">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title">Error</h4>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body bg-warning-subtle">
                <p id="modal-warning-msg"></p>
            </div>
            <div class="modal-footer justify-content-between">
                @*<button type="button" class="btn btn-default" data-bs-dismiss="modal">Cancelar</button>*@
                <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Aceptar</button>
            </div>
        </div>
    </div>
</div>