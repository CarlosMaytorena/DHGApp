@model AgricolaDH_GApp.ViewModels.SubirFacturaVM

<div class="text-center">

    <div class="row top-row-spacer">
        <div class="col-md-8">
            <h4 class="page-title">Ingresar</h4>
        </div>
        <div class="col-md-2">
            <button id="volverAIndex" class="btn btn-block btn-secondary">
                Regresar
            </button>
        </div>
        <div class="col-md-2">
            <button id="realizarIngresoConfirm" class="btn btn-block secondary-background-color" style="color: white">
                <i class="nav-icon fas fa-arrow-right"></i> Recibir
            </button>
        </div>
    </div>

    <div class="card card-margin">
        <!-- Order and Date Section -->
        <div class="row card-row-spacer">
            <div class="col-md-8">
                <label style="font-weight: normal; text-align: left; float: left">Orden de compra</label>
                <input id="orderNumber" class="form-control" value="@Model.ordenDeCompra.IdOrdenDeCompra" readonly />
            </div>
            <div class="col-md-4">
                <label style="font-weight: normal; text-align: left; float: left">Fecha</label>
                <input type="date" class="form-control" value="@Model.ordenDeCompra.FechaOrdenDeCompra?.ToString("yyyy-MM-dd")" readonly />
            </div>
        </div>

        <!-- Dynamic Product Section -->
        <div class="row card-row-spacer">
            <label style="font-weight: normal; text-align: left; float: left; margin-right: 10px;">Productos a Ordenar</label>
        </div>

        <div id="productContainer">
            @if (Model.productosOrdenar != null && Model.productosOrdenar.Any())
            {
                @for (int i = 0; i < Model.productosOrdenar.Count; i++)
                {
                    <div class="row card-row-spacer product-row">
                        <div class="col-md-4">
                            <label style="font-weight: normal; text-align: left; float: left">Producto</label>

                            @Html.HiddenFor(m => m.productosOrdenar[i].IdProductoOrdenar)

                            @Html.EditorFor(m => m.productosOrdenar[i].NombreDropdown,
                                new { htmlAttributes = new { @class = "form-control input-focus subirFactura", @readonly = "true", @data_index = i } })
                            <input type="hidden" class="product-name-raw" value="@Model.productosOrdenar[i].Producto" />

                            <input type="hidden" class="product-id" value="@Model.productosOrdenar[i].IdProductoOrdenar" />
                            <input type="hidden" class="product-barcode" data-barcode-value="" />
                        </div>

                        <div class="col-md-2">
                            <label style="font-weight: normal; text-align: left; float: left">Cantidad Esperada</label>
                            <input type="number" class="form-control cantidad-esperada" value="@Model.productosOrdenar[i].Cantidad" readonly />
                        </div>
                        <div class="col-md-1">
                            <label style="font-weight: normal; text-align: left; float: left">Restante</label>
                            <input type="number"
                                   class="form-control cantidad-restante"
                                   value="@Model.productosOrdenar[i].PorRecibir"
                                   readonly
                                   data-restante-inicial="@Model.productosOrdenar[i].PorRecibir" />
                        </div>
                        <div class="col-md-1">
                            <label style="font-weight: normal; text-align: left; float: left">Recibir</label>
                            <input type="number"
                                   class="form-control cantidad-recibida"
                                   min="0"
                                   oninput="updateRestante(this)"
                                   onchange="updateRestante(this)" />
                        </div>
                        <div class="col-md-2">
                            <label style="font-weight: normal; text-align: left; float: left">Unidad</label>
                            <input class="form-control" value="@Model.productosOrdenar[i].Unidad" readonly />
                        </div>
                        <div class="col-md-2">
                            <label style="font-weight: normal; text-align: left; float: left">Total</label>
                            <input class="form-control" value="@Model.productosOrdenar[i].Total" readonly />
                        </div>
                    </div>
                }
                <div style="height: 30px;"></div>
            }
        </div>
    </div>
</div>

<script type="module">
    // ---- Short serial (12-char Crockford Base32 from SHA-256) ----
    const CROCKFORD = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";
    
    function scrambleSerial(serial) {
        if (!serial || serial.length !== 12) return serial;
        // "123456ABCDEF" -> "ABCDEF123456"
        return serial.substring(6) + serial.substring(0, 6);
    }
    
    function allRestantesBaseCero() {
        let allZero = true;

        $(".product-row").each(function () {
            const restanteBase = parseInt(
                $(this).find(".cantidad-restante").data("restante-inicial"),
                10
            ) || 0;

            if (restanteBase > 0) {
                allZero = false;
            }
        });

        return allZero;
    }

    function goToIngresosIndex() {
        $.ajax({
            url: '@Url.Action("Index", "Ingresos")',
            type: 'GET',
            success: function (data) {
                $("#HtmlBody").html(data);
            },
            error: function () {
                showWarning("Error al regresar al listado de Ingresos.");
            }
        });
    }
    
    function bytesToBase32(bytes, outLen) {
        let bits = 0, value = 0, out = "";
        for (let i = 0; i < bytes.length && out.length < outLen; i++) {
            value = (value << 8) | bytes[i];
            bits += 8;
            while (bits >= 5 && out.length < outLen) {
                out += CROCKFORD[(value >>> (bits - 5)) & 31];
                bits -= 5;
            }
        }
        if (out.length < outLen && bits > 0) {
            out += CROCKFORD[(value << (5 - bits)) & 31];
        }
        return out.padEnd(outLen, "0");
    }

    async function shortSerialFrom(pn, order, idx, length = 12) {
        const source = `${pn}|${order}|${idx}`;
        const data = new TextEncoder().encode(source);
        const hash = await crypto.subtle.digest("SHA-256", data);
        return bytesToBase32(new Uint8Array(hash), length);
    }

    // --------------------------------------------------------------

    function updateRestante(input) {
        const $row = $(input).closest(".product-row");
        const restanteBase = parseInt($row.find(".cantidad-restante").data("restante-inicial"), 10) || 0;
        let recibida = parseInt($(input).val(), 10) || 0;
        if (recibida < 0) recibida = 0;
        if (recibida > restanteBase) recibida = restanteBase;
        $(input).val(recibida);
        $row.find(".cantidad-restante").val(restanteBase - recibida);
    }
    window.updateRestante = updateRestante;

    //  restauramos tu script original de impresión
    import { openPrintWindow } from "/js/labelPrinter.js";

    function showWarning(msg) {
        $("#modal-warning-msg").text(msg);
        $("#modal-warning").modal("show");
    }

    function showSuccess(msg) {
        $("#modal-success-msg").text(msg);
        $("#modal-success").modal("show");
    }


    $(document).ready(function () {

        function initRecibirDefaults() {
            $(".product-row").each(function () {
                const $row = $(this);
                const restanteBase = parseInt($row.find(".cantidad-restante").data("restante-inicial"), 10) || 0;

                const $recibir = $row.find(".cantidad-recibida");
                $recibir.val(restanteBase); 
                updateRestante($recibir[0]); 

                
                if (restanteBase === 0) {
                    $recibir.prop("disabled", true);
                } else {
                    $recibir.prop("disabled", false);
                }
            });
        }

        initRecibirDefaults();



        $("#volverAIndex").click(function () {
            $.ajax({
                url: '@Url.Action("Index", "Ingresos")',
                type: 'GET',
                success: function (data) { $("#HtmlBody").html(data); },
                error: function () {
                    showWarning("Error al regresar al listado de órdenes.");
                }
            });
        });

        $(document).on('input', '.cantidad-recibida', function () {
            updateRestante(this);
        });

        $(".product-row").each(function () {
            const $row = $(this);
            const productName = $row.find(".product-name-raw").val();

            if (!productName) return;
            $.ajax({
                url: '/Ingresos/GetProductBarcodeID',
                type: 'GET',
                data: { nombreProducto: productName },
                success: function (response) {
                    if (response.success) {
                        $row.find(".product-barcode").data("barcode-value", response.barcodeID);
                    } else {
                        console.error(`Error: ${response.message}`);
                    }
                },
                error: function () { console.error("Error fetching product barcode."); }
            });
        });

        $("#realizarIngresoConfirm").off("click").on("click", async function () {
            const receivedProducts = [];
            const labelsToPrint = [];
            const rows = $(".product-row").toArray();
            const workOrderNumber = $("#orderNumber").val();

            for (const el of rows) {
                const $row = $(el);
                const productId = $row.find(".product-id").val();
                const productName = $row.find("input[readonly]").first().val();
                const partNumber = $row.find(".product-barcode").data("barcode-value");
                const recibida = parseInt($row.find(".cantidad-recibida").val(), 10) || 0;
                const esperada = parseInt($row.find(".cantidad-esperada").val(), 10) || 0;
                const restanteBase = parseInt($row.find(".cantidad-restante").data("restante-inicial"), 10) || 0;

                if (!productName || !partNumber) continue;
                if (restanteBase === 0) continue;
                if (recibida <= 0) continue;
                if (recibida > restanteBase) {
                    showWarning(`No puedes recibir más de lo que queda en Restante para: ${productName}`);
                    return;
                }

                const newRestante = restanteBase - recibida;
                const yaRecibido = esperada - restanteBase;

                const shortSerials = [];
                for (let i = 1; i <= recibida; i++) {
                    const unitIndex = yaRecibido + i;
                    const shortSerial = (await shortSerialFrom(partNumber, workOrderNumber, unitIndex)).toUpperCase();
                    shortSerials.push(shortSerial);

                    const scrambled = scrambleSerial(shortSerial);


                    // usamos tu formato original
                    labelsToPrint.push(`
                            <div class="label">
                                <h4>Orden: ${workOrderNumber}</h4>
                                <h4>Producto: ${productName}</h4>
                                <h4 class="serial-header">Serial: ${scrambled}</h4>
                                <svg class="barcode" 
                                    data-barcode-value="${shortSerial}"
                                    data-scrambled="${scrambled}"></svg>
                                <div class="serial-below">${scrambled}</div>
                            </div>
                        `);
                }

                $row.find(".cantidad-restante").val(newRestante).data("restante-inicial", newRestante);

                receivedProducts.push({
                    IdProductoOrdenar: productId,
                    Recibida: recibida,
                    PorRecibir: newRestante,
                    SerialesCortos: shortSerials
                });
            }

            console.log(receivedProducts);

            if (receivedProducts.length === 0) {
                showWarning("No se han ingresado productos válidos.");
                return;
            }

            $.ajax({
                type: "POST",
                url: "/Ingresos/ActualizarPorRecibir",
                data: JSON.stringify(receivedProducts),
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    if (response.success) {
                        showSuccess("Ingreso registrado correctamente.");

                        if (labelsToPrint.length > 0) {
                            openPrintWindow(labelsToPrint.join(''), workOrderNumber);
                        }

                        window.salirAlIndex = allRestantesBaseCero();
                    } else {
                        showWarning("Hubo un error al actualizar los datos.");
                    }
                },
                error: function () {
                    showWarning("Error al enviar la solicitud.");
                }

            });
        });

        $("#modal-success").on("hidden.bs.modal", function () {
            if (window.salirAlIndex) {
                goToIngresosIndex();
                window.salirAlIndex = false;
            }
        });
    });
</script>

<div class="modal fade" id="modal-success" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Confirmación</h4>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="modal-success-msg">Ingreso registrado correctamente.</p>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-warning">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title">Error</h4>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body bg-warning-subtle">
                <p id="modal-warning-msg"></p>
            </div>
            <div class="modal-footer justify-content-between">
                @*<button type="button" class="btn btn-default" data-bs-dismiss="modal">Cancelar</button>*@
                <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Aceptar</button>
            </div>
        </div>
    </div>
</div>
