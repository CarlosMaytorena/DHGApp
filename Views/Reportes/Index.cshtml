@model AgricolaDH_GApp.ViewModels.ReporteEgresosPageVM


<div class="row top-row-spacer" style="margin-bottom: 2vh">
    <div class="col-md-6">
        <h4 class="page-title">Reportes</h4>
    </div>
</div>

<div class="card" style="margin:20px;">
    <div class="card-header p-0">
        <ul class="nav nav-tabs d-flex" id="tabsReportes">
            <li class="nav-item">
                <a class="nav-link active custom-tabs" href="#" data-tipo="egresos" style="color: #0f0f0f">
                    Egresos
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link custom-tabs" href="#" data-tipo="salidas" style="color: #0f0f0f">
                    Salidas
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link custom-tabs" href="#" data-tipo="entradas" style="color: #0f0f0f">
                    Entradas
                </a>
            </li>

            <li class="nav-item ms-auto me-3 d-flex align-items-center" style="margin-left: auto; margin-right: 5px; padding: 5px;">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown">
                        üóÇ √Årea
                    </button>

                    <div class="dropdown-menu p-3" style="min-width: 220px;">
                        <select id="filtroArea" class="form-control">
                            <option value="">Todas las √°reas</option>
                            @foreach (var a in Model.Filtros.Areas)
                            {
                                <option value="@a.Value">@a.Text</option>
                            }
                        </select>
                    </div>
                </div>
            </li>

            <li class="nav-item me-3 d-flex align-items-center" style="margin-right: 5px; padding: 5px;">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown">
                        üë§ Solicitante
                    </button>

                    <div class="dropdown-menu p-3" style="min-width: 220px;">
                        <select id="filtroSolicitante" class="form-control">
                            <option value="">Todos</option>
                            @foreach (var s in Model.Filtros.Solicitantes)
                            {
                                <option value="@s.Value">@s.Text</option>
                            }
                        </select>
                    </div>
                </div>
            </li>


            <li class="nav-item ms-auto me-3 d-flex align-items-center" style="margin-right: 20px; padding: 5px;">
                <!-- DROPDOWN CALENDARIO -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown">
                        üìÖ Rango de fechas
                    </button>

                    <div class="dropdown-menu p-3" style="min-width: 280px;">
                        <div class="mb-2">
                            <label class="form-label">Fecha inicio</label>
                            <input type="date" id="fechaInicio" class="form-control">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Fecha fin</label>
                            <input type="date" id="fechaFin" class="form-control">
                        </div>

                        <button id="btnAplicarFechas" class="btn btn-primary w-100">
                            Aplicar
                        </button>
                    </div>
                </div>
            </li>



        </ul>

    </div>

    <div class="card-body">
        <div id="contenedorReporte">
            <div class="alert alert-info">
                Selecciona un reporte para visualizar la informaci√≥n.
            </div>
        </div>
    </div>
</div>

<script>

    var tipoActual = 'egresos';
    var fechaInicio = null;
    var fechaFin = null;

    $(document).ready(function () {

        // Al cargar, dispara Egresos por default
        cargarReporte('egresos');

        $('#tabsReportes .nav-link').click(function (e) {
            e.preventDefault();

            $('#tabsReportes .nav-link').removeClass('active');
            $(this).addClass('active');

            tipoActual = $(this).data('tipo');
            cargarReporte(tipoActual);
        });

    });

    $(document).ready(function () {
        const hoy = new Date();
        const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

        $('#fechaInicio').val(primerDia.toISOString().split('T')[0]);
        $('#fechaFin').val(hoy.toISOString().split('T')[0]);
    });



    $('#btnAplicarFechas').on('click', function () {

        fechaInicio = $('#fechaInicio').val();
        fechaFin = $('#fechaFin').val();

        if (!fechaInicio || !fechaFin) {
            alert('Selecciona ambas fechas');
            return;
        }

        // Cierra dropdown
        $(this).closest('.dropdown-menu').prev().dropdown('toggle');

        // ‚úÖ RECARGA EL REPORTE
        cargarReporte();
    });

    function cargarReporte() {
        $.get("/Reportes/LoadReporte", {
            tipo: "egresos",
            fechaInicio: $("#fechaInicio").val(),
            fechaFin: $("#fechaFin").val(),
            idArea: $("#filtroArea").val(),
            idSolicitante: $("#filtroSolicitante").val()
        }, function (html) {
            $("#contenedorReporte").html(html);
        });
    }

    $("#filtroArea, #filtroSolicitante").change(cargarReporte);




</script>